<!--
███    ███ ██ ███    ██ ███████ ███████ ██     ██ ███████ ███████ ██████  ███████ ██████
████  ████ ██ ████   ██ ██      ██      ██     ██ ██      ██      ██   ██ ██      ██   ██
██ ████ ██ ██ ██ ██  ██ █████   ███████ ██  █  ██ █████   █████   ██████  █████   ██████
██  ██  ██ ██ ██  ██ ██ ██           ██ ██ ███ ██ ██      ██      ██      ██      ██   ██
██      ██ ██ ██   ████ ███████ ███████  ███ ███  ███████ ███████ ██      ███████ ██   ██
-->
<!-- Original code: -->
<!-- https://slicker.me/javascript/mine/minesweeper.htm -->

{% extends 'header.html' %}
<!-- ^^ This means add this file to the end of the contents of header.html -->
<!-- This is where the title, top buttons, and stylesheet is located -->

<!-- Change title here -->
{% block title %}Minesweeper{% endblock %}

<!-- Extra style declarations here -->
{% block style %}
  <style>
    body {
      text-align: center;
      margin-top: 24px;
      font-size: 32px;
    }

    #button {
      margin-top: 24px;
      font-size: 24px;
    }

    #minebox {
      position: fixed;
      left: calc(50% - 300px);
      top: 20%;
    }
  </style>
{% endblock %}

<!-- Change theme color here -->
{% block color %}green{% endblock %}

<!-- Main content here -->
{% block main %}
  <label id='status'></label><br>
  <button id="button" class="hidden">Restart</button>
  <br>
  <div id="minebox"></div>
{% endblock %}

<!-- Extra JavaScript here -->
{% block script %}
  <script>
      const rows = {{ rows }};
      const columns = {{ cols }};
      const dense = {{ dense }};
      let mines, remaining, revealed;
      let status = document.getElementById('status');
      let button = document.getElementById('button');
      var minebox = document.getElementById('minebox')
      minebox.setAttribute("oncontextmenu", "return false;")
      button.addEventListener('click', init)

      let board = new Array(rows);
      let picture = new Array(rows);
      let tile = new Array(rows);
      for (let i = 0; i < board.length; i++) {
          board[i] = new Array(columns);
          picture[i] = new Array(columns);
          tile[i] = new Array(columns)
      }

      init();

      function check(row, column) {
          if (column >= 0 && row >= 0 && column < columns && row < rows)
              return board[row][column];
      }

      function init() {
          mines = (rows*columns)/dense;
          remaining = mines;
          revealed = 0;
          status.innerHTML = 'Click on the tiles to reveal them';
          button.classList.add('hidden');
          for (let row = 0; row < rows; row++)
              for (let column = 0; column < columns; column++) {
                  let index = row * columns + column;
                  tile[row][column] = document.createElement('img');
                  tile[row][column].src = '../static/img/mnsw/hidden.png';
                  tile[row][column].style = 'position:absolute;height:30px;width:30px;top:'+(row*30)+'px;left:'+(column*30)+'px;';
                  // tile[row][column].style.top = 150 + row * 30;
                  // tile[row][column].style.left = 50 + column * 30;
                  tile[row][column].addEventListener('mousedown', click);
                  tile[row][column].id = index;
                  minebox.appendChild(tile[row][column]);
                  picture[row][column] = 'hidden';
                  board[row][column] = '';
              }

          let placed = 0;
          while (placed < mines) {
              let column = Math.floor(Math.random() * columns);
              let row = Math.floor(Math.random() * rows);

              if (board[row][column] != 'mine') {
                  board[row][column] = 'mine';
                  placed++;
              }
          }

          for (let column = 0; column < columns; column++)
              for (let row = 0; row < rows; row++) {
                  if (check(row, column) != 'mine') {
                      board[row][column] =
                          ((check(row + 1, column) == 'mine') | 0) +
                          ((check(row + 1, column - 1) == 'mine') | 0) +
                          ((check(row + 1, column + 1) == 'mine') | 0) +
                          ((check(row - 1, column) == 'mine') | 0) +
                          ((check(row - 1, column - 1) == 'mine') | 0) +
                          ((check(row - 1, column + 1) == 'mine') | 0) +
                          ((check(row, column - 1) == 'mine') | 0) +
                          ((check(row, column + 1) == 'mine') | 0);
                  }
              }
      }

      function click(event) {
          let source = event.target;
          let id = source.id;
          let row = Math.floor(id / columns);
          let column = id % columns;

          button.classList.remove('hidden');

          if (event.which == 3) {
              switch (picture[row][column]) {
                  case 'hidden':
                      tile[row][column].src = '../static/img/mnsw/flag.png';
                      remaining--;
                      picture[row][column] = 'flag';
                      break;
                  case 'flag':
                      tile[row][column].src = '../static/img/mnsw/question.png';
                      remaining++;
                      picture[row][column] = 'question';
                      break;
                  case 'question':
                      tile[row][column].src = '../static/img/mnsw/hidden.png';
                      picture[row][column] = 'hidden';
                      break;
              }
              event.preventDefault();
          }
          status.innerHTML = 'Mines remaining: ' + (remaining < 0 ? 0 : remaining);

          if (event.which == 1 && picture[row][column] != 'flag') {
              if (board[row][column] == 'mine') {
                  for (let row = 0; row < rows; row++)
                      for (let column = 0; column < columns; column++) {
                          if (board[row][column] == 'mine') {
                              tile[row][column].src = '../static/img/mnsw/mine.png';
                          }
                          if (board[row][column] != 'mine' && picture[row][column] == 'flag') {
                              tile[row][column].src = '../static/img/mnsw/misplaced.png';
                          }
                      }
                  status.innerHTML = 'GAME OVER';
                  document.body.style.background = "var(--bg-dark-red)";
              } else
              if (picture[row][column] == 'hidden') reveal(row, column);
          }

          if (revealed == rows * columns - mines) {
              status.innerHTML = 'YOU WIN!';
              document.body.style.background = "var(--bg-dark-blue)";
          }
      }

      function reveal(row, column) {
          tile[row][column].src = '../static/img/mnsw/' + board[row][column] + '.png';
          if (board[row][column] != 'mine' && picture[row][column] == 'hidden')
              revealed++;
          picture[row][column] = board[row][column];

          if (board[row][column] == 0) {
              if (column > 0 && picture[row][column - 1] == 'hidden') reveal(row, column - 1);
              if (column < (columns - 1) && picture[row][+column + 1] == 'hidden') reveal(row, +column + 1);
              if (row < (rows - 1) && picture[+row + 1][column] == 'hidden') reveal(+row + 1, column);
              if (row > 0 && picture[row - 1][column] == 'hidden') reveal(row - 1, column);
              if (column > 0 && row > 0 && picture[row - 1][column - 1] == 'hidden') reveal(row - 1, column - 1);
              if (column > 0 && row < (rows - 1) && picture[+row + 1][column - 1] == 'hidden') reveal(+row + 1, column - 1);
              if (column < (columns - 1) && row < (rows - 1) && picture[+row + 1][+column + 1] == 'hidden') reveal(+row + 1, +column + 1);
              if (column < (columns - 1) && row > 0 && picture[row - 1][+column + 1] == 'hidden') reveal(row - 1, +column + 1);
          }
      }
  </script>
{% endblock %}
